version: '3.1'

services:
  pihole:
    container_name: pi-hole
    image: pihole/pihole
    ports:
      - '53:53/tcp'
      - '53:53/udp'
      - '67:67/udp'
      - '8080:80/tcp'
      - '443:443/tcp'
    environment:
      TZ: 'America/Argentina/Buenos_Aires'
    volumes:
      - 'pihole_data/:/etc/pihole/'
      - './pi-hole/etc-dnsmasq.d/:/etc/dnsmasq.d/'
    cap_add:
      - NET_ADMIN
    restart: unless-stopped

  vaultwarden:
    container_name: vaultwarden
    image: vaultwarden/server
    environment:
      ROCKET_TLS: '{certs="/ssl/bitwarden.crt",key="/ssl/bitwarden.key"}' 
    ports:
      - '8200:80'
    volumes:
      - 'vaultwarden_data:/data/'
      - './bitwarden/config/:/config'
      - './bitwarden/certificates/:/ssl/'
    restart: unless-stopped

  # Documentation: <https://docs.miguelndecarvalho.pt/projects/speedtest-exporter>
  speedtest:
    container_name: speedtest
    image: miguelndecarvalho/speedtest-exporter
    restart: unless-stopped

  prometheus:
    container_name: prometheus
    image: prom/prometheus
    volumes:
      - 'prometheus_data:/prometheus'
      - './prometheus/:/etc/prometheus/'
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=90d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - '9090:9090'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    restart: unless-stopped

  grafana:
    container_name: grafana
    image: grafana/grafana
    volumes:
      - 'grafana_data:/var/lib/grafana'
      - './grafana/provisioning/:/etc/grafana/provisioning/'
    ports:
      - '3000:3000'
    restart: unless-stopped

  cadvisor:
    image: cadvisor
    container_name: cadvisor
    command: --docker_only=true
    build:
      context: cadvisor
    privileged: true
    volumes:
      - '/:/rootfs:ro'
      - '/var/run:/var/run:ro'
      - '/sys:/sys:ro'
      - '/var/lib/docker/:/var/lib/docker:ro'
      - '/dev/disk/:/dev/disk:ro'
    devices:
      - '/dev/kmsg:/dev/kmsg'
    restart: unless-stopped

  node_exporter:
    container_name: node_exporter
    image: quay.io/prometheus/node-exporter
    container_name: node_exporter
    command:
      - '--path.rootfs=/host'
    network_mode: host
    pid: host
    volumes:
      - '/:/host:ro,rslave'
    restart: unless-stopped

  qbittorrent:
    container_name: qbittorrent
    image: lscr.io/linuxserver/qbittorrent:arm64v8-latest
    environment:
      - UMASK=003
      - PUID=1002 # qbittorrent
      - PGID=1003 # downloads
      - TZ=America/Argentina/Buenos_Aires
      - WEBUI_PORT=8010
    volumes:
      - qbittorrent_config:/config
      - /srv/dev-disk-by-uuid-86def75f-182c-4802-9f6a-b158f7df08b6/downloads:/downloads
    ports:
      - '6881:6881'
      - '6881:6881/udp'
      - '8010:8010'
    restart: unless-stopped

  youtubedl:
    container_name: youtubedl
    image: youtube-dl-nas
    build:
      context: youtubedl
    environment:
      - MY_ID=modenaf360
      - MY_PW=1234
      - TZ=America/Argentina/Buenos_Aires
    volumes:
      - /srv/dev-disk-by-uuid-86def75f-182c-4802-9f6a-b158f7df08b6/downloads:/downfolder
    ports:
      - '8020:8080'
    restart: unless-stopped

volumes:
  pihole_data:
  vaultwarden_data:
  grafana_data:
  prometheus_data:
  qbittorrent_config:
